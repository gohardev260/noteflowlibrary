<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Notes Library – Public Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script src="notes-api.js"></script>
  <style>
    :root {
      --cream: #FFFFFF;
      --light-cream: #FFFFFF;
      --brown: #0F172A;
      --dark-brown: #0F172A;
      --medium-brown: #3B82F6;
      --light-brown: #3B82F6;
      --glass: rgba(59, 130, 246, 0.08);
      --stroke: rgba(59, 130, 246, 0.15);
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
      --card-radius: 18px;
    }

    /* Background decorations */
    .bg-blur {
      filter: blur(80px);
      opacity: 0.25;
      pointer-events: none;
      animation: float 20s ease-in-out infinite;
    }

    /* Floating animation for background orbs */
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      25% { transform: translateY(-20px) rotate(90deg); }
      50% { transform: translateY(0px) rotate(180deg); }
      75% { transform: translateY(20px) rotate(270deg); }
    }

    /* Gradient text animation */
    @keyframes gradient-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .gradient-text {
      background: linear-gradient(-45deg, var(--medium-brown), var(--brown), #6366f1, var(--medium-brown));
      background-size: 400% 400%;
      animation: gradient-shift 4s ease infinite;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Pulse animation for counters */
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); }
      50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.6), 0 0 30px rgba(59, 130, 246, 0.4); }
    }

    .pulse-counter {
      animation: pulse-glow 2s ease-in-out infinite;
    }

    /* Stagger animation for cards */
    @keyframes slide-up {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .stagger-animation {
      animation: slide-up 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    /* Header slide down animation */
    @keyframes slide-down {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    header {
      animation: slide-down 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    /* Hero content animation */
    @keyframes fade-in-up {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .hero-content {
      animation: fade-in-up 1s cubic-bezier(0.2, 0.8, 0.2, 1) 0.3s both;
    }

    .hero-controls {
      animation: fade-in-up 1s cubic-bezier(0.2, 0.8, 0.2, 1) 0.6s both;
    }

    /* Modal entrance animation */
    @keyframes modal-fade-in {
      from {
        opacity: 0;
        backdrop-filter: blur(0px);
      }
      to {
        opacity: 1;
        backdrop-filter: blur(8px);
      }
    }

    @keyframes modal-scale-in {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal.open {
      display: grid;
      animation: modal-fade-in 0.3s ease-out;
    }

    .modal.open .modal-card {
      animation: modal-scale-in 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    /* Button hover effects */
    .btn {
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    /* Search input focus animation */
    @keyframes input-focus {
      from {
        box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.15);
      }
      to {
        box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.15);
      }
    }

    .input:focus-within {
      animation: input-focus 0.3s ease-out;
    }

    /* Tag hover animation */
    .tag {
      position: relative;
      overflow: hidden;
    }

    .tag::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }

    .tag:hover::after {
      width: 200%;
      height: 200%;
    }

    /* Loading animation for dynamic content */
    @keyframes shimmer {
      0% { background-position: -200px 0; }
      100% { background-position: calc(200px + 100%) 0; }
    }

    .loading-shimmer {
      background: linear-gradient(90deg, #f0f0f0 0px, #e0e0e0 40px, #f0f0f0 80px);
      background-size: 200px 100%;
      animation: shimmer 1.5s infinite;
    }

    /* Card styles */
    .note-card {
      border-radius: var(--card-radius);
      background: var(--light-cream);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      transform: translateY(0) scale(1);
      transition: transform 320ms cubic-bezier(.2, .8, .2, 1), box-shadow 320ms, border-color 320ms, background 320ms;
      overflow: hidden;
    }

    .note-card:hover {
      transform: translateY(-6px) scale(1.01);
      border-color: var(--light-brown);
      background: #FFFFFF;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.25);
    }

    /* Image container with aspect ratio and fallback */
    .image-wrap {
      position: relative;
      aspect-ratio: 16/10;
      background: linear-gradient(135deg, var(--light-brown) 0%, var(--medium-brown) 100%);
      overflow: hidden;
      display: grid;
      place-items: center;
    }

    .image-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 600ms cubic-bezier(.2, .8, .2, 1);
    }

    .note-card:hover .image-wrap img {
      transform: scale(1.05);
    }

    /* Fallback state if image fails */
    .image-wrap.img-fallback {
      background: linear-gradient(135deg, var(--medium-brown), var(--brown));
    }

    .image-wrap.img-fallback .fallback-graphic {
      opacity: 1;
      transform: translateY(0);
    }

    .fallback-graphic {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      color: var(--light-cream);
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 300ms, transform 300ms;
    }

    .fallback-graphic .chip {
      border: 1px dashed var(--light-cream);
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.4);
    }

    /* Tag styles */
    .tag {
      border: 1px solid var(--light-brown);
      background: rgba(59, 130, 246, 0.15);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      color: var(--brown);
      transition: transform 200ms, background 200ms, border-color 200ms;
      cursor: pointer;
      user-select: none;
    }

    .tag:hover {
      transform: translateY(-2px);
      background: rgba(59, 130, 246, 0.25);
      border-color: var(--medium-brown);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--light-brown);
      background: var(--light-cream);
      color: var(--brown);
      transition: transform 200ms, border-color 200ms, background 200ms, box-shadow 200ms;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.15);
    }

    .btn:hover {
      transform: translateY(-2px);
      border-color: var(--medium-brown);
      background: #FFFFFF;
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.25);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--medium-brown), var(--brown));
      color: var(--light-cream);
      border: none;
    }

    .btn.primary:hover {
      filter: brightness(1.1);
      transform: translateY(-2px);
    }

    .btn.share {
      background: linear-gradient(135deg, var(--light-brown), var(--medium-brown));
      color: white;
      border: none;
    }

    .btn.share:hover {
      filter: brightness(1.1);
      transform: translateY(-2px);
    }

    /* Appear animation */
    @keyframes float-in {
      from {
        opacity: 0;
        transform: translateY(12px) scale(.98)
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1)
      }
    }

    .will-animate {
      opacity: 0;
    }

    .in-view {
      animation: float-in .6s cubic-bezier(.2, .8, .2, 1) forwards;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      background: rgba(15, 23, 42, 0.65);
      backdrop-filter: blur(8px);
      z-index: 50;
    }

    .modal.open {
      display: grid;
    }

    .modal-card {
      width: min(1000px, 92vw);
      max-height: 84vh;
      overflow: hidden;
      border-radius: 20px;
      background: var(--light-cream);
      border: 1px solid var(--light-brown);
      box-shadow: 0 30px 80px rgba(15, 23, 42, 0.3);
      display: grid;
      grid-template-rows: auto 1fr;
    }

    .modal-body {
      overflow: auto;
    }

    /* Responsive modal adjustments */
    @media (max-width: 768px) {
      .modal-card {
        width: 100%;
        height: 100%;
        max-height: 100vh;
        border-radius: 0;
      }

      .modal-body {
        padding: 1rem;
      }

      .modal-body .grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .modal-body .image-wrap {
        max-height: 200px;
      }
    }

    /* Inputs */
    .input {
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid var(--light-brown);
      border-radius: 14px;
      padding: 12px 14px;
      background: #FFFFFF;
      color: var(--dark-brown);
      transition: border-color 200ms, background 200ms, box-shadow 200ms;
      box-shadow: inset 0 1px 0 rgba(15, 23, 42, 0.06);
    }

    .input:focus-within {
      border-color: var(--medium-brown);
      background: #FFFFFF;
      box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.15);
    }

    .input input,
    .input select {
      background: transparent;
      outline: none;
      border: none;
      width: 100%;
      color: var(--dark-brown);
    }

    .input select option {
      background: var(--light-cream);
      color: var(--dark-brown);
    }

    /* Counters */
    .counter-chip {
      border: 1px solid var(--light-brown);
      background: rgba(59, 130, 246, 0.15);
      color: var(--brown);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
    }

    /* Scrollbar polish */
    ::-webkit-scrollbar {
      height: 10px;
      width: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--light-brown);
      border-radius: 999px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }
  </style>
</head>

<body class="bg-cream text-dark-brown" style="background-color: var(--cream); color: var(--dark-brown);">
  <!-- Background orbs -->
  <div class="fixed inset-0 -z-10 overflow-hidden">
    <div class="absolute -top-24 -left-24 w-[540px] h-[540px] rounded-full bg-blur"
      style="background-color: var(--light-brown); opacity: 0.15;"></div>
    <div class="absolute -bottom-24 -right-24 w-[620px] h-[620px] rounded-full bg-blur"
      style="background-color: var(--medium-brown); opacity: 0.15;"></div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-40 border-b backdrop-blur"
    style="border-color: var(--light-brown); background-color: rgba(255,255,255,0.85);">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl grid place-items-center shadow-lg"
          style="background: linear-gradient(135deg, var(--medium-brown), var(--brown));">
          <!-- Simple inline SVG mark (not an <img>) -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="white" stroke-width="1.4" stroke-linecap="round"
              stroke-linejoin="round" />
            <path d="M20 22H6.5A2.5 2.5 0 0 1 4 19.5V5.5A2.5 2.5 0 0 1 6.5 3H20" stroke="white" stroke-width="1.4"
              stroke-linecap="round" stroke-linejoin="round" />
            <path d="M20 22V3" stroke="white" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </div>
        <div class="leading-tight">
          <div class="text-lg font-semibold tracking-wide">NoteFlow Library</div>
          <div class="text-xs" style="color: var(--medium-brown);">Explore, preview, and download class notes</div>
        </div>
      </div>
      <div class="hidden md:flex items-center gap-3">
        <span class="counter-chip" id="countChip" aria-live="polite">0 notes</span>
        <a href="admin.html" class="btn primary">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.6"/>
          </svg>
          Admin
        </a>
      </div>
    </div>
  </header>

  <!-- Hero / Controls -->
  <section class="relative">
    <div class="max-w-7xl mx-auto px-4 py-10 md:py-14">
      <div class="grid md:grid-cols-12 gap-6 items-start">
        <div class="md:col-span-7 hero-content">
          <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight leading-tight">
            Discover high‑quality study notes
            <span class="block gradient-text">Search,
              filter, preview, and download</span>
          </h1>
          <p class="mt-4 max-w-2xl" style="color: var(--medium-brown);">
            Use the search to find notes by title or tags, filter by class, preview the content, and download what you
            need for offline study.
          </p>
        </div>
        <div class="md:col-span-5 hero-controls">
          <div class="rounded-2xl p-4 md:p-6 border backdrop-blur"
            style="border-color: var(--light-brown); background-color: rgba(255,255,255,0.9);">
            <div class="flex gap-3 flex-col">
              <label class="sr-only" for="searchInput">Search by title or tags</label>
              <div class="input">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="color: var(--medium-brown);">
                  <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.6"></circle>
                  <path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path>
                </svg>
                <input id="searchInput" placeholder="Search by title or tags..."
                  aria-label="Search notes by title or tags" />
                <button id="clearSearch" class="transition text-sm"
                  style="color: var(--medium-brown); opacity: 0.7;">Clear</button>
              </div>

              <div class="grid md:grid-cols-2 gap-3">
                <div class="input">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="color: var(--medium-brown);">
                    <path d="M6 9h12M6 13h8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path>
                    <rect x="3" y="4" width="18" height="16" rx="3" stroke="currentColor" stroke-width="1.6"></rect>
                  </svg>
                  <select id="classFilter" aria-label="Filter by class">
                    <option value="All">All Classes</option>
                    <!-- Will be populated dynamically -->
                  </select>
                </div>
                <button id="resetFilters" class="btn w-full">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M20 12a8 8 0 1 1-2.343-5.657" stroke="currentColor" stroke-width="1.6"
                      stroke-linecap="round" />
                    <path d="M20 4v6h-6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                      stroke-linejoin="round" />
                  </svg>
                  Reset
                </button>
              </div>

              <div id="quickTags" class="flex flex-wrap gap-2 pt-1">
                <!-- Dynamic tag chips will be populated here -->
              </div>

              <div class="flex items-center gap-3 pt-2">
                <span class="counter-chip" id="visibleCount">Showing 0</span>
                <span class="text-sm" id="totalCountText" style="color: var(--medium-brown);">of 0 notes</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Divider -->
      <div class="mt-8 h-px w-full"
        style="background: linear-gradient(to right, transparent, var(--light-brown), transparent);"></div>
    </div>
  </section>

  <!-- Notes Grid -->
  <main id="notes" class="max-w-7xl mx-auto px-4 pb-20">
    <div id="cardsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      <!-- Dynamic notes will be loaded here by index-app.js -->
      ...existing code...
  </main>

  <footer class="border-t py-10 text-center text-sm"
    style="border-color: var(--light-brown); color: var(--medium-brown);">
    <p>Made with <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="display: inline; vertical-align: middle; color: #ef4444;"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg> by Gohar Rehman</p>
  </footer>

  <script type="text/plain">
    // Utility: Convert simple markdown-like headings to HTML
    function renderSimpleMarkdown(text){
      const lines = text.trim().split('\n');
      const html = lines.map(line=>{
        if(line.startsWith('### ')) return '<h3 class="text-lg font-semibold mt-4 mb-2">' + line.substring(4) + '</h3>';
        if(line.startsWith('## ')) return '<h2 class="text-xl font-bold mt-4 mb-2">' + line.substring(3) + '</h2>';
        if(line.startsWith('# ')) return '<h1 class="text-2xl font-extrabold mt-2 mb-3">' + line.substring(2) + '</h1>';
        if(line.match(/^\s*-\s+/)) return '<li>' + line.replace(/^\s*-\s+/, '') + '</li>';
        if(line.trim()==='') return '';
        return '<p class="mt-2">' + line + '</p>';
      }).join('\n').replace(/(<li>[\s\S]*?<\/li>)/g, '<ul class="list-disc pl-5">$1</ul>');
      return html;
    }

    // Gather elements
    const grid = document.getElementById('cardsGrid');

    // Inject notes from admin localStorage before collecting cards
    (function injectAdminNotes(){
      try {
        const stored = JSON.parse(localStorage.getItem('adminNotes') || '[]');
        if (!Array.isArray(stored) || stored.length === 0) return;

        const frag = document.createDocumentFragment();
        stored.forEach(note => {
          const article = document.createElement('article');
          article.className = 'note-card will-animate';
          article.setAttribute('tabindex', '0');
          article.dataset.title = note.title || 'Untitled';
          article.dataset.tags = (note.tags || '').trim();
          article.dataset.class = note.class || 'General';
          article.dataset.fileUrl = (note.fileUrl || '').trim();

          // Image wrap
          const imageWrap = document.createElement('div');
          imageWrap.className = 'image-wrap';

          const img = document.createElement('img');
          img.src = note.image || '';
          img.alt = `Cover image for ${note.title || 'note'}`;
          img.addEventListener('error', () => {
            img.style.display = 'none';
            imageWrap.classList.add('img-fallback');
          });
          imageWrap.appendChild(img);

          const fallback = document.createElement('div');
          fallback.className = 'fallback-graphic';
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.textContent = `Image unavailable — ${note.class || 'Note'}`;
          fallback.appendChild(chip);
          imageWrap.appendChild(fallback);

          // Body
          const body = document.createElement('div');
          body.className = 'p-5 flex flex-col gap-4';

          // Header
          const header = document.createElement('header');
          header.className = 'flex items-start justify-between gap-3';

          const h3 = document.createElement('h3');
          h3.className = 'font-semibold text-lg leading-snug';
          h3.textContent = note.title || 'Untitled';

          const classChip = document.createElement('span');
          classChip.className = 'px-2 py-1 rounded-md text-xs bg-cyan-400/15 text-cyan-200 border border-cyan-400/30';
          classChip.textContent = note.class || 'General';

          header.appendChild(h3);
          header.appendChild(classChip);

          // Description
          const desc = document.createElement('p');
          desc.className = 'text-sm text-slate-400 line-clamp-3';
          desc.textContent = note.description || '';

          // Tags
          const tagsWrap = document.createElement('div');
          tagsWrap.className = 'flex flex-wrap gap-2';
          (note.tags || '').split(',').map(s=>s.trim()).filter(Boolean).forEach(tag=>{
            const span = document.createElement('span');
            span.className = 'tag';
            span.dataset.tag = tag;
            span.textContent = tag;
            tagsWrap.appendChild(span);
          });

          // Buttons
          const actions = document.createElement('div');
          actions.className = 'flex items-center gap-2 pt-1';

          const previewBtn = document.createElement('button');
          previewBtn.className = 'btn primary preview-btn';
          previewBtn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 12s3.5-6.5 9-6.5S21 12 21 12s-3.5 6.5-9 6.5S3 12 3 12z" stroke="currentColor" stroke-width="1.6"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6"/></svg>
            Preview
          `;

          const downloadBtn = document.createElement('button');
          downloadBtn.className = 'btn download-btn';
          downloadBtn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 4v10m0 0 3.5-3.5M12 14 8.5 10.5M4 20h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Download
          `;

          actions.appendChild(previewBtn);
          actions.appendChild(downloadBtn);

          // Note content (markdown)
          const noteContent = document.createElement('div');
          noteContent.className = 'note-content hidden';
          noteContent.textContent = note.content || '';

          // Assemble
          body.appendChild(header);
          body.appendChild(desc);
          body.appendChild(tagsWrap);
          body.appendChild(actions);
          body.appendChild(noteContent);

          article.appendChild(imageWrap);
          article.appendChild(body);

          frag.appendChild(article);
        });

        grid.appendChild(frag);
      } catch (err) {
        console.warn('Admin notes injection failed:', err);
      }
    })();

    // Now collect cards (includes injected)
    const cards = Array.from(grid.querySelectorAll('.note-card'));
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');
    const classFilter = document.getElementById('classFilter');
    const resetFilters = document.getElementById('resetFilters');
    const visibleCount = document.getElementById('visibleCount');
    const countChip = document.getElementById('countChip');
    const totalCountText = document.getElementById('totalCountText');

    const modal = document.getElementById('previewModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalClass = document.getElementById('modalClass');
    const modalTags = document.getElementById('modalTags');
    const modalImage = document.getElementById('modalImage');
    const modalContent = document.getElementById('modalContent');
    const modalClose = document.getElementById('modalClose');
    const modalDownload = document.getElementById('modalDownload');

    // Populate class filter dynamically from cards
    (function populateClasses(){
      const classes = new Set(cards.map(c => c.dataset.class));
      const frag = document.createDocumentFragment();
      Array.from(classes).sort().forEach(cls=>{
        const opt = document.createElement('option');
        opt.value = cls;
        opt.textContent = cls;
        frag.appendChild(opt);
      });
      classFilter.appendChild(frag);

      // Set counters
      countChip.textContent = cards.length + ' notes';
      totalCountText.textContent = 'of ' + cards.length + ' notes';
    })();

    // Intersection Observer for appear animations
    const observer = new IntersectionObserver(entries=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          entry.target.classList.add('in-view');
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.15 });

    cards.forEach(c=>observer.observe(c));

    // Tag click to search
    function setSearchValue(val){
      searchInput.value = val;
      applyFilters();
    }
    document.getElementById('quickTags').addEventListener('click', e=>{
      const tag = e.target.closest('.tag')?.dataset.tag;
      if(tag) setSearchValue(tag);
    });

    // Also make tags inside cards interactive
    cards.forEach(card=>{
      card.querySelectorAll('.tag').forEach(tagEl=>{
        tagEl.addEventListener('click', ()=>{
          setSearchValue(tagEl.dataset.tag || tagEl.textContent.trim());
        });
      });
    });

    // Core filtering function
    function applyFilters(){
      const q = searchInput.value.trim().toLowerCase();
      const cls = classFilter.value;

      let shown = 0;
      cards.forEach(card=>{
        const title = card.dataset.title.toLowerCase();
        const tagStr = card.dataset.tags.toLowerCase();
        const cardClass = card.dataset.class;

        const matchSearch = q === '' || title.includes(q) || tagStr.includes(q);
        const matchClass = cls === 'All' || cls === cardClass;

        const visible = matchSearch && matchClass;
        card.style.display = visible ? '' : 'none';
        if(visible) shown++;
      });

      // Update counts
      visibleCount.textContent = 'Showing ' + shown;
      totalCountText.textContent = 'of ' + cards.length + ' notes';
    }

    // Event bindings
    searchInput.addEventListener('input', applyFilters);
    classFilter.addEventListener('change', applyFilters);
    clearSearch.addEventListener('click', ()=>{
      searchInput.value = '';
      applyFilters();
      searchInput.focus();
    });
    resetFilters.addEventListener('click', ()=>{
      searchInput.value = '';
      classFilter.value = 'All';
      applyFilters();
    });

    // Initial filter render
    applyFilters();

    // Preview modal logic
    function openModalFromCard(card){
      modalTitle.textContent = card.dataset.title;
      modalClass.textContent = card.dataset.class;

      // Fill tags
      modalTags.innerHTML = '';
      (card.dataset.tags || '').split(',').map(s=>s.trim()).filter(Boolean).forEach(tag=>{
        const span = document.createElement('span');
        span.className = 'px-2 py-0.5 rounded-md border';
        span.style.backgroundColor = 'rgba(59, 130, 246, 0.15)';
        span.style.color = 'var(--brown)';
        span.style.borderColor = 'rgba(59, 130, 246, 0.3)';
        span.textContent = '#' + tag;
        span.onclick = ()=>{ setSearchValue(tag); closeModal(); };
        modalTags.appendChild(span);
      });

      // Use the card image for modal image
      const img = card.querySelector('.image-wrap img');
      if(img){
        // reset fallback class on modal image container
        modalImage.closest('.image-wrap').classList.remove('img-fallback');
        modalImage.style.display = '';
        modalImage.src = img.getAttribute('src');
        modalImage.alt = img.getAttribute('alt') || 'Preview image for the selected note with academic cover in modern gradient';
      }

      // Content
      const content = card.querySelector('.note-content')?.textContent || '';
      modalContent.innerHTML = renderSimpleMarkdown(content);

      // Download action mirrors the card
      modalDownload.onclick = ()=>{
        triggerDownload(card);
      };

      modal.classList.add('open');
      document.body.style.overflow = 'hidden';
    }
    function closeModal(){
      modal.classList.remove('open');
      document.body.style.overflow = '';
    }
    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal.classList.contains('open')) closeModal(); });

    // Attach preview/download to each card
    function triggerDownload(card){
      const fileUrl = (card.dataset.fileUrl || '').trim();
      if (fileUrl) {
        const a = document.createElement('a');
        a.href = fileUrl;
        a.target = '_blank';
        a.rel = 'noopener';
        document.body.appendChild(a);
        a.click();
        a.remove();
        return;
      }

      const title = card.dataset.title || 'note';
      const content = card.querySelector('.note-content')?.textContent.trim() || '';
      const frontmatter = [
        '---',
        'title: "' + title.replace(/"/g, '\\"') + '"',
        'class: "' + (card.dataset.class || '') + '"',
        'tags: [' + (card.dataset.tags || '').split(',').map(s=>'"' + s.trim().replace(/"/g, '\\"') + '"').join(', ') + ']',
        'generatedAt: "' + new Date().toISOString() + '"',
        '---',
        ''
      ].join('\n');
      const blob = new Blob([frontmatter + content + '\n'], {type: 'text/markdown;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') + '.md';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 0);
    }

    cards.forEach(card=>{
      card.querySelector('.preview-btn')?.addEventListener('click', ()=>openModalFromCard(card));
      card.querySelector('.download-btn')?.addEventListener('click', ()=>triggerDownload(card));
      // Keyboard: Enter to preview
      card.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){
          openModalFromCard(card);
        }
      });
    });

    // Accessibility: announce count changes
    const liveRegion = document.createElement('div');
    liveRegion.setAttribute('aria-live', 'polite');
    liveRegion.className = 'sr-only';
    document.body.appendChild(liveRegion);
    const originalApply = applyFilters;
    // Wrap to announce changes (keep reference)
    function announceFilters(){
      originalApply();
      liveRegion.textContent = visibleCount.textContent + ' ' + totalCountText.textContent;
    }
    // Rebind with announcement
    searchInput.removeEventListener('input', applyFilters);
    classFilter.removeEventListener('change', applyFilters);
    searchInput.addEventListener('input', announceFilters);
    classFilter.addEventListener('change', announceFilters);
    clearSearch.addEventListener('click', announceFilters);
    resetFilters.addEventListener('click', announceFilters);

    // Run once to announce initial state
    announceFilters();
  </script>
  <script src="index-app.js"></script>
</body>

</html>